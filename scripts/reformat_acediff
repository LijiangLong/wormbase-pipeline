#!/usr/local/bin/perl5.6.1 -w
#
# reformat_acediff.pl
#
# splits acediff output into tag deletions and tag insertions
#
# dl 

use strict;

my $file = shift;                  # acefile to reformat


our @add;
our @delete;

my $oldname = "nill";
my $name;
my $class;
my $add;
my $delete;
my $debug;

# read the acefile data into memory
open (FILE, "<$file");
while (<FILE>) {

    chop;
    next if ($_ eq "");
    next if (/^\/\//);

    if (/^Sequence \"(\S+)\"/) {
	$class = "Sequence";
	$name = $1;
	if ($oldname eq "nill") {$oldname = $name;next;}	
	&report;
	$oldname = $name;
	next;
    }    
    
    if (/^Feature \"(\S+)\"/) {
	$class = "Feature";
	$name = $1;
	if ($oldname eq "nill") {$oldname = $name;next;}	
	&report;
	$oldname = $name;
	next;
    }    
    
    if (/^Pseudogene \"(\S+)\"/) {
	$class = "Pseudogene";
	$name = $1;
	if ($oldname eq "nill") {$oldname = $name;next;}	
	&report;
	$oldname = $name;
	next;
    }    
    
    
    if (/^Transcript \"(\S+)\"/) {
	$class = "Transcript";
	$name = $1;
	if ($oldname eq "nill") {$oldname = $name;next;}	
	&report;
	$oldname = $name;
	next;
    }    


    # parse delete/addition lines
    if (/^-D/) {
	push (@delete,$_);
	print "- $_\n" if ($debug);
    }
    else {
	push (@add,$_);
	print "+ $_\n" if ($debug);
    }
}
close FILE;

&report;

exit(0);




sub report {
    
    print "// report for $class $oldname\n";
    
    if (scalar (@delete) > 0) {
	print "\n$class \"$oldname\"\n";
	foreach $delete (@delete) {
	    print "$delete\n";
	}
	undef @delete;
    }
    
    if (scalar (@add) > 0) {
	print "\n$class \"$oldname\"\n";
	foreach $add (@add) {
	    print "$add\n";
	}
	undef @add;
    }

    print "\n";
}

