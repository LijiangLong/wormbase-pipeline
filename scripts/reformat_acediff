#!/usr/local/bin/perl5.6.1 -w
#
# reformat_acediff.pl
#
# splits acediff output into tag deletions and tag insertions
#
# dl 

use strict;

my $file = shift;                  # acefile to reformat


our @add;
our @delete;

my $oldname = "nill";
my $name;
my $class;
my $add;
my $delete;
my $debug;
my $in_block = 0;
my $line;

# read the acefile data into memory
open (FILE, "<$file");
while (<FILE>) {

    chomp;
    next if (/^\/\//);
    $line = $_;

#    print  "// [$in_block] '$line' \n";

    if (($line =~/^CDS \"(\S+)\"/) && ($in_block == 0)) {
	$class = "CDS";
	$name = $1;
	&report unless ($oldname eq "nill");
	$in_block = 1;
	$oldname = $name;
	next;
    }    
    elsif (($line =~/^Sequence \"(\S+)\"/) && ($in_block == 0)) {
	$class = "Sequence";
	$name = $1;
	&report unless ($oldname eq "nill");
	$in_block = 1;
	$oldname = $name;
	next;
    }    
    elsif (($line =~/^Feature \"(\S+)\"/) && ($in_block == 0)) {
	$class = "Feature";
	$name = $1;
	&report unless ($oldname eq "nill");
	$in_block = 1;
	$oldname = $name;
	next;
    }    
    elsif (($line =~/^Pseudogene \"(\S+)\"/) && ($in_block == 0)) {
	$class = "Pseudogene";
	$name = $1;
	&report unless ($oldname eq "nill");
	$in_block = 1;
	$oldname = $name;
	next;
    }    
    elsif (($line =~/^Transcript \"(\S+)\"/) && ($in_block == 0)) {
	$class = "Transcript";
	$name = $1;
	&report unless ($oldname eq "nill");
	$in_block = 1;
	$oldname = $name;
	next;
    }
    elsif (($line =~/^Transposon \"(\S+)\"/) && ($in_block == 0)) {
	$class = "Transposon";
	$name = $1;
	&report unless ($oldname eq "nill");
	$in_block = 1;
	$oldname = $name;
	next;
    }
    elsif ($line eq "") {
	$in_block = 0;
	next;
    }
    # parse delete/addition lines
    if (/^-D/) {
	push (@delete,$_);
	print "- $_\n" if ($debug);
    }
    else {
	push (@add,$_);
	print "+ $_\n" if ($debug);
    }
}
close FILE;

&report;

exit(0);




sub report {
    
    print "// report for $class $oldname\n";
    
    if (scalar (@delete) > 0) {
	print "\n$class \"$oldname\"\n";
	foreach $delete (@delete) {
	    print "$delete\n";
	}
	undef @delete;
    }
    
    if (scalar (@add) > 0) {
	print "\n$class \"$oldname\"\n";
	foreach $add (@add) {
	    print "$add\n";
	}
	undef @add;
    }

    print "\n";
} 

