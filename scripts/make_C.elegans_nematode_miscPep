#!/usr/local/bin/perl5.6.1 -w 
#
# Script to pull out all the celegans nematode  misc sequences 
# dl 

use strict;

$|=1;

open (OUTPUT,     ">/nfs/disk100/wormpub/analysis/ESTs/C.elegans_nematode_miscPep");
open (OUTPUT_ace, ">/nfs/disk100/wormpub/analysis/ESTs/C.elegans_nematode_miscPep.ace");

my $acc     = "";  # EMBL accession number
my $id      = "";  # EMBL ID
my $sv      = "";  # EMBL sequence version
my $def     = "";  # EMBL description
my $protid  = "";  # EMBL Protein_ID
my $protver = "";  # EMBL Protein_ID version


open (SEQUENCES, "/usr/local/pubseq/bin/getz -e \'(((([libs={emblrelease emblnew}-Organism:Caenorhabditis elegans*]) & [libs-Division:INV*]) & [libs-Molecule:DNA*])) ! (((([libs={emblrelease emblnew}-Organism:Caenorhabditis elegans*]) & [libs-Division:INV*]) & [libs-Molecule:DNA*]) & [libs-Keywords:HTG*]))\' |");

while (<SEQUENCES>) {
    chomp;
    if (/^\s/) {                   # matches only the sequence lines
	s/\s+//g;                  # remove white space
	s/\d+//g;                  # remove numerals
	print OUTPUT_ace "$_\n";   # print to output
    }
    
    if (/^ID\s+(\S+)/)                         {$id  = $1;}
    if (/^SV\s+(\S+)\.(\d+)/)                  {$acc = $1; $sv  = $2;}
    if (/^DE\s+(.+)/)                          {$def = $def." ".$1;}
    if (/^FT\s+\/protein_id=\"(\S+)\.(\d+)\"/) {$protid=$1; $protver=$2;}
    if (/^SQ/) {
	print "// Parsed accession $acc\n";

	open (CDS, "CDS.pl $acc |");   # Ugly. this needs rationalising dl
	while  (<CDS>) {
	    print OUTPUT $_;
	}
	close CDS;

	# print out the acefile version
	print OUTPUT_ace   "\nSequence : \"$acc\"\nDatabase EMBL $id $acc $sv\n";
	print OUTPUT_ace   "Species \"Caenorhabditis elegans\"\n";
	print OUTPUT_ace   "Title \"$def\"\nMethod NDB\n";
	print OUTPUT_ace  "\nDNA \"$acc\"\n";
	
	# reset vars
	$def = ""; $id = ""; $acc = ""; $sv = ""; $protid = ""; $protver ="";
    }
}

close SEQUENCES;
close OUTPUT;
close OUTPUT_ace;

exit(0);
