#!/usr/local/bin/perl5.6.0 -w
#
# autoace_minder
# dl
#
# Usage : autoace_minder [-options]
#

#################################################################################
# Initialise variables                                                          #
#################################################################################

$|=1;
use IO::Handle;
use Getopt::Std;
use lib "/wormsrv2/scripts/";
use Wormbase;
use strict;
use vars qw ($opt_a $opt_w $opt_b $opt_1 $opt_2 $opt_3 $opt_c $opt_p $opt_q $opt_f $opt_z $opt_n $opt_d $opt_s $opt_x $opt_h $opt_g $opt_m $opt_i $opt_u $opt_y );

 ##############################
 # Script variables (run)     #
 ##############################

my $maintainers = "dl1\@sanger.ac.uk krb\@sanger.ac.uk kj2\@sanger.ac.uk";
my $rundate     = `date +%y%m%d`; chomp $rundate;
my $runtime     = `date +%H:%M:%S`; chomp $runtime;
my $version     = &get_cvs_version("$0");

# specify location of scripts
my $scriptdir   = "/wormsrv2/scripts";

 ##############################
 # command-line options       #
 ##############################

# $opt_i="";   # Start the build process 
# $opt_u="";   # unpack primaries
# $opt_a="";   # Full release (does all the following)
# $opt_w="";   # Write .acefiles
# $opt_b="";   # Build autoace 
# $opt_1="";   # Build autoace : DB only
# $opt_2="";   # Build autoace : CHROMOSOMES directory
# $opt_3="";   # Build autoace : Release directory
# $opt_c="";   # Check DB consistency
# $opt_p="";   # Build wormpep
# $opt_q="";   # prepare pepace and then dump from pepace into autoace
# $opt_f="";   # Wormbase release to FTP site
# $opt_z="";   # Public release to FTP site
# $opt_d="";   # Verbose debug mode
# $opt_h="";   # Help/Usage page
# $opt_g="";   # chromosome_dump.pl -g
# $opt_m="";   # map PCR, RNAi and WTP

# $opt_n="";   # copy autoace before blatting
# $opt_s="";   # map similarities (BLAT jobs)
# $opt_x="";   # parse blat files

# $opt_y="";   # make agp files for the yellow brick road

getopts ('awbchipqfzdrsguymn123');
&usage(0) if ($opt_h);

# -d debug mode modifies $maintainers to reduce e-mail load
($maintainers = "dl1\@sanger.ac.uk") if ($opt_d);

# build flag path
our $logdir     = "/wormsrv2/autoace/logs";
our $build_flag = "$logdir/build_in_progress";
our $WSver_file = "/wormsrv2/autoace/wspec/database.wrm";

our ($WS_version,$WS_previous);

our $tace =  "/nfs/disk100/acedb/RELEASE.DEVELOPMENT/bin.ALPHA_4/tace";


# are you building a new database?
&initiate_build if ($opt_i);

 #######################################
 # fetch WS version number             #
 #######################################

$WS_version = &get_wormbase_version;

# exit if no WS version is returned
&usage(1) if (!defined($WS_version));

# exit if WS version (database.wrm) is older than build_in_process flag
# i.e. the WS version has been changed since the start of the build
&usage(11) if (-M $build_flag < -M $WSver_file);

# manipulate to assign last WS release version
$WS_previous = $WS_version -1;

 ########################################
 # logfiles                             #
 ########################################

our $logfile = "/wormsrv2/logs/autoace_minder.WS${WS_version}.${rundate}";

open (LOG,">$logfile");
LOG->autoflush();

&logfile_details;


 ########################################
 # if all then set all flags            #
 ########################################

if ($opt_a) {
    $opt_w = 1; $opt_b = 1; $opt_c = 1; $opt_p = 1; $opt_q = 1; $opt_g = 1; $opt_m = 1; $opt_y = 1;
}

#################################################################################
# Main Loop                                                                     #
#################################################################################

# prepare
&prepare_primaries     if ($opt_u);

# build
&make_acefiles         if ($opt_w);
&make_autoace          if ($opt_b);

# sub list to do fine work within build
 &make_DB               if ($opt_1);
 &make_DNA              if ($opt_2);
 &make_release          if ($opt_3);

# checks
&check_release          if ($opt_c);

# similarity matches
&pre_blat_copy          if ($opt_n);
&blat_jobs              if ($opt_s);
&parse_blat_files       if ($opt_s || $opt_x);

# wormpep and protein work
&make_wormpep          if ($opt_p);
&pepace_stuff          if ($opt_q);

&make_FTP_wormbase     if ($opt_f);
&make_anonymous_FTP    if ($opt_z);
&dump_GFFs             if ($opt_g);
&map_PCR_RNAi_and_WTP  if ($opt_m);
&make_agp              if ($opt_y);

 ##############################
 # mail $maintainer report    #
 ##############################

close LOG;

&mail_maintainer("WormBase Report: autoace_minder",$maintainers,$logfile);

 ##############################
 # hasta luego                #
 ##############################

exit(0);



#################################################################################
### Subroutines                                                               ###
#################################################################################

#################################################################################
# initiate autoace build                                                        #
#################################################################################

sub initiate_build {

    local (*FLAG);
    my $cvs_file = "/wormsrv2/autoace/wspec/database.wrm";

    # exit if build_in_progress flag is present
    &usage(10) if (-e $build_flag);
    
    # commit to new build ..............
    $WS_version = &get_wormbase_version;
    
    # exit if no WS version is returned
    &usage(1) if (!defined($WS_version));
    
    # manipulate to assign last WS release version
    my $WS_new_name = $WS_version +1;
 
    # make new build_in_process flag
    system ("touch $build_flag");
    open (FLAG, ">>$build_flag"); 
    print FLAG "WS$WS_new_name\n";
    close FLAG;
 
    # make sure that the database.wrm file is younger
    sleep 10;
    
    # update database.wrm using cvs
    print "Updating $cvs_file to include new WS number - using CVS\n\n";
    system ("cvs -d '/nfs/ensembl/cvsroot/' edit $cvs_file")                                           && die "Couldn't 'cvs edit' $cvs_file\n";
    system ("sed 's/$WS_version/$WS_new_name/' < $cvs_file > ${cvs_file}.new")                         && die "Couldn't edit $cvs_file\n";
    system ("mv /wormsrv2/autoace/wspec/database.wrm.new $cvs_file")                                   && die "Couldn't update $cvs_file\n";
    system ("cvs -d '/nfs/ensembl/cvsroot/' commit -m 'updating $cvs_file to $WS_new_name' $cvs_file") && die "Couldn't 'cvs commit' $cvs_file\n";

}

#################################################################################
# prepare primary databases                                                     #
#################################################################################

sub prepare_primaries {
    
    local (*LAST_VER);
    my ($stlace_date,$brigdb_date,$citace_date,$cshace_date) = &FTP_versions;
    my ($stlace_last,$brigdb_last,$citace_last,$cshace_last) = &last_versions;
    my $options = "";

    # stlace
    print "\nstlace : $stlace_date last_build $stlace_last";
    unless ($stlace_last eq $stlace_date) {
	$options .= " -s $stlace_date";
	print "  => Update stlace";
    }

    # brigdb
    print "\nbrigdb : $brigdb_date last_build $brigdb_last";
    unless ($brigdb_last eq $brigdb_date) {
	$options .= " -b $brigdb_date";
	print "  => Update brigdb";
    }

    # citace
    print "\ncitace : $citace_date last_build $citace_last";
    unless ($citace_last eq $citace_date) {
	$options .= " -i $citace_date";
	print "  => Update citace";
    }

    # cshace
    print "\ncshace : $cshace_date last_build $cshace_last";
    unless ($cshace_last eq $cshace_date) {
	$options .= " -c $cshace_date";
	print "  => Update cshace";
    }
 
    print "\n\nrunning unpack_db.pl $options\n";
 
    # confirm unpack_db details, execute and update Primary_databases_used_in_build file
    unless ($options eq "") {
	
	print "Do you want to unpack these databases ?\n";
	my $answer=<STDIN>;
	&usage(2) if ($answer ne "y\n");
	
	system ("$scriptdir/unpack_db.pl $options");
	
	# rewrite /wormsrv2/autoace/Primary_databases_used_in_build
	open (LAST_VER, ">$logdir/Primary_databases_used_in_build");
	print LAST_VER "stlace : $stlace_date\n"; 
	print LAST_VER "brigdb : $brigdb_date\n"; 
	print LAST_VER "citace : $citace_date\n"; 
	print LAST_VER "cshace : $cshace_date\n"; 
	close LAST_VER;
    }

    # transfer /wormsrv1/camace to /wormsrv2/camace 
    
    system("TransferDB -start /wormsrv1/camace -end /wormsrv2/camace -database -wspec -name camace")
	&& die "Couldn't run TransferDB for camace\n";

    # transfer /wormsrv1/geneace to /wormsrv2/geneace 
    
    system("TransferDB -start /wormsrv1/geneace -end /wormsrv2/geneace -database -wspec -name geneace")
	&& die "Couldn't run TransferDB for geneace\n";

    # check that all databases are present and working
    #
    # do we need this? 

    # make a unpack_db.pl log file in /logs
    system ("touch $logdir/primary_databases_on_wormsrv2");

}

sub FTP_versions {

    local (*STLACE_FTP,*BRIGDB_FTP,*CITACE_FTP,*CSHACE_FTP);

    my $stlace_FTP = "/nfs/disk100/wormpub/private_ftp/incoming/stl/stlace_*";
    my $brigdb_FTP = "/nfs/disk100/wormpub/private_ftp/incoming/stl/brigdb_*";
    my $citace_FTP = "/nfs/disk100/wormpub/private_ftp/incoming/caltech/citace_*";
    my $cshace_FTP = "/nfs/disk100/wormpub/private_ftp/incoming/csh/cshl_*";
    my ($stlace_date,$brigdb_date,$citace_date,$cshace_date);

    # stlace
    open (STLACE_FTP, "/bin/ls -t $stlace_FTP |")  || die "cannot open $stlace_FTP\n";
    while (<STLACE_FTP>) {
	chomp;
	(/\_(\d+)\-(\d+)\-(\d+)\./);
	$stlace_date = substr($1,-2).$2.$3;    
        last;
    }
    close STLACE_FTP; 

    # brigdb
    open (BRIGDB_FTP, "/bin/ls -t $brigdb_FTP |");
    while (<BRIGDB_FTP>) {
	chomp;
	(/\_(\d+)\-(\d+)\-(\d+)\./);
	$brigdb_date = substr($1,-2).$2.$3;    
	last;
    }
    close BRIGDB_FTP; 

    # citace
    open (CITACE_FTP, "/bin/ls -t $citace_FTP |");
    while (<CITACE_FTP>) {
	chomp;
	(/\_(\d+)\-(\d+)\-(\d+)\./);
	$citace_date = substr($1,-2).$2.$3;
	last;
    }
    close CITACE_FTP; 

    # cshace
    open (CSHACE_FTP, "/bin/ls -t $cshace_FTP |");
    while (<CSHACE_FTP>) {
	chomp;
	(/\_(\d+)\-(\d+)\-(\d+)\./);
	$cshace_date = substr($1,-2).$2.$3;
	last;
    }
    close CSHACE_FTP; 
    
    # return current dates as 6-figure string
    return($stlace_date,$brigdb_date,$citace_date,$cshace_date);
}

sub last_versions {
    
    local (*LAST_VER);
    my ($stlace_last,$brigdb_last,$citace_last,$cshace_last);

    open (LAST_VER, "<$logdir/Primary_databases_used_in_build") || die "can't open old file\n";
    while (<LAST_VER>) {
	$stlace_last = $1 if /^stlace \: (\d+)$/;
	$brigdb_last = $1 if /^brigdb \: (\d+)$/;
	$citace_last = $1 if /^citace \: (\d+)$/;
	$cshace_last = $1 if /^cshace \: (\d+)$/;
    }
    close LAST_VER;

    usage(3) if (!defined $stlace_last);
    usage(4) if (!defined $brigdb_last);
    usage(5) if (!defined $citace_last);
    usage(6) if (!defined $cshace_last);

    # return last version dates as 6-figure string
    return($stlace_last,$brigdb_last,$citace_last,$cshace_last);

}



#################################################################################
# make_acefiles                                                                 #
#################################################################################

sub make_acefiles {

    system ("$scriptdir/make_acefiles -ne") && die "Couldn't run make_acefiles\n";
    print LOG " Write acefiles to disk\n";
    print LOG " => 'make_acefiles -ne'\n\n";

    # make a make_acefiles log file in /logs
    system ("touch $logdir/wrote_acefiles_to_wormbase");

}



#################################################################################
# make_autoace                                                                  #
#################################################################################
# 
# requires: acefiles in /wormsrv2/wormbase directories
#           config file to drive loading of data (autoace.config)
#

sub make_autoace {

    # quit if make_acefiles has not been run
    &usage(8) unless (-e "$logdir/wrote_acefiles_to_wormbase");
	
    system ("$scriptdir/make_autoace -p /wormsrv2/autoace -rc") && die "Couldn't run autoace -rc\n";
    print LOG " Build autoace (database/CHROMOSOMES/release)\n";
    print LOG " =>'make_autoace -p /wormsrv2/autoace -rc'\n\n";

    # make a make_autoace log file in /logs
    system ("touch $logdir/make_autoace_complete");

}

sub make_DB {
    system ("$scriptdir/make_autoace -p /wormsrv2/autoace -r") && die "Couldn't run autoace -r\n" ;
    print LOG " Build autoace (database)\n";
    print LOG " => 'make_autoace -p /wormsrv2/autoace -r'\n\n";
}

sub make_DNA {
    system ("$scriptdir/chromosome_dump.pl -dce")  && die "Couldn't run chromosome_dump.pl -dce\n";
    print LOG " Build autoace (CHROMOSOMES)\n";
    print LOG " =>'chromosome_dump.pl -dc'\n\n";
}

sub make_release {
    system ("$scriptdir/make_autoace -p /wormsrv2/autoace -d")  && die "Couldn't run autoace -d\n"; 
    print LOG " Build autoace (release)\n";
    print LOG " => 'make_autoace -p /wormsrv2/autoace -d'\n\n";
}

#################################################################################
# check_release                                                                 #
#################################################################################

sub check_release {

    # exit if autoace has not been built
    &usage(7) unless (-e "$logdir/make_autoace_complete");

    # have you run GFFsplitter ?
    # if no then this is about checking the DNA/agp files
    unless ((-e "$logdir/GFF_files_split") && (-e "$logdir/made_agp_files")) {
	
	&dump_GFFs;
	system ("$scriptdir/check_DNA.pl") && die "Couldn't run check_DNA.pl\n";
	system ("$scriptdir/make_agp_file.pl") && die "Couldn't run make_agp_file.pl\n";
	system ("$scriptdir/agp2dna.pl") && die "Couldn't run agp2dna.pl\n";
	
	# make a make_autoace log file in /logs
	system ("touch $logdir/made_agp_files");

    }
    # if yes then this is about checking the class counts
    else {
	system ("$scriptdir/dbcomp -f /wormsrv2/WS${WS_previous}") && die "Couldn't run dbcomp -f\n";
	print LOG " Make dbcomp report\n";
	print LOG " => 'dbcomp -f /wormsrv2/WS${WS_previous}'\n\n";
    }
}

#################################################################################
# similarity mapping                                                            #
#################################################################################

sub pre_blat_copy {
    # make a copy of the database so far
    # transfer /wormsrv1/geneace to /wormsrv2/geneace 
    
    system("TransferDB -start /wormsrv2/autoace -end /wormsrv2/autoace_midway -database -wspec -name autoace_midway")
	&& die "Couldn't run TransferDB for autoace\n";
    
    print LOG " Copy autoace prior to BLAT analysis\n";
    
    # make a make_autoace log file in /logs
    system ("touch $logdir/copy_autoace_before_BLAT_run");

    
}

sub blat_jobs {
    
    local (*WRITEDB);


    # run the blat jobs

    # blat_them_all -e
    system ("$scriptdir/blat_them_all.pl -nbsve") && die "Couldn't blat_them_all -nbsve\n";

    # blat_them_all -m
    system ("$scriptdir/blat_them_all.pl -bsm") && die "Couldn't blat_them_all -nbsve\n";

    # blat_them_all -o
    system ("$scriptdir/blat_them_all.pl -bso") && die "Couldn't blat_them_all -nbsve\n";

    # blat_them_all -x
    system ("$scriptdir/blat_them_all.pl -bsx") && die "Couldn't blat_them_all -nbsve\n";

    # quit if blat_them_all has not been run
    &usage(9) unless (-e "$logdir/blat_transcript_data");

    # read in the ace files (autoace only)
}

sub parse_blat_files {

my $command=<<END;
pparse /wormsrv2/autoace/BLAT/virtual_objects.autoace.BLAT_EST.ace 
pparse /wormsrv2/autoace/BLAT/virtual_objects.autoace.BLAT_mRNA.ace 
pparse /wormsrv2/autoace/BLAT/virtual_objects.autoace.BLAT_EMBL.ace 
pparse /wormsrv2/autoace/BLAT/virtual_objects.autoace.BLATX_NEMATODE.ace 
pparse /wormsrv2/autoace/BLAT/virtual_objects.autoace.ci.EST.ace 
pparse /wormsrv2/autoace/BLAT/virtual_objects.autoace.ci.mRNA.ace 
pparse /wormsrv2/autoace/BLAT/virtual_objects.autoace.ci.EMBL.ace 
save
pparse /wormsrv2/autoace/BLAT/autoace.blat.EST.ace            
save
pparse /wormsrv2/autoace/BLAT/autoace.blat.mRNA.ace 
save
pparse /wormsrv2/autoace/BLAT/autoace.blat.EMBL.ace 
save
pparse /wormsrv2/autoace/BLAT/autoace.blat.nematode.ace 
save
pparse /wormsrv2/autoace/BLAT/autoace.good_introns.EST.ace 
save
pparse /wormsrv2/autoace/BLAT/autoace.good_introns.mRNA.ace 
save
pparse /wormsrv2/autoace/BLAT/autoace.good_introns.EMBL.ace 
save 
quit
END

    open (WRITEDB, "| $tace -tsuser Sanger_BLAT_data /wormsrv2/autoace |") || die "Couldn't open pipe to autoace\n";
    print WRITEDB $command;
    close WRITEDB;
    
    # make a make_autoace log file in /logs
    system ("touch $logdir/loaded_BLAT_similarities");


}


#################################################################################
# make_wormpep                                                                  #
#################################################################################

sub make_wormpep {
    system ("$scriptdir/make_wormpep -r $WS_version") && die "Couldn't run make_wormpep -r\n";
    print LOG " Build wormpep release $WS_version\n";
    print LOG " =>'make_wormpep -r $WS_version'\n\n";

}

#################################################################################
# pepace stuff - run patch_pepace.pl then pepace2autoace                        #
#################################################################################

sub pepace_stuff {
    system ("$scriptdir/patch_pepace.pl") && die "Couldn't run patch_pepace.pl\n";
    print LOG " Reading patch_pepace files into pepace\n";
    print LOG " =>'patch_pepace.pl'\n\n";

    system ("$scriptdir/pepace2autoace") && die "Couldn't run pepace2autoace\n";
    print LOG " Dumping files from pepace and reading into autoace\n";
    print LOG " =>'pepace2autoace'\n\n";
}
#################################################################################
# dump GFF files                                                                #
#################################################################################

sub dump_GFFs {
    system ("$scriptdir/chromosome_dump.pl -g") && die "Couldn't make GFF files\n";
    print LOG " Dumped GFF files for $WS_version\n";
    print LOG " =>'chromosome_dump.pl -g'\n\n";

}


#################################################################################
# map PCR, RNAi and WTP                                                         #
#################################################################################

sub map_PCR_RNAi_and_WTP {
    system("$scriptdir/map_PCR_products") && die "Couldn't run map_PCR_products\n";
    print LOG " Mapped PCR products for $WS_version\n";
    print LOG " =>'map_PCR_products'\n\n";
    system("$scriptdir/map_RNAi.pl") && die "Couldn't run map_RNAi.pl\n";
    print LOG " Mapped RNAi experiments for $WS_version\n";
    print LOG " =>'map_RNAi.pl'\n\n";
    system("$scriptdir/map_WTP.pl") && die "Couldn't run map_WTP.pl\n";
    print LOG " Mapped WTP objects for $WS_version\n";
    print LOG " =>'map_WTP.pl'\n\n";
}


#################################################################################
# make agp file for yellow brick road                                           #
#################################################################################

sub make_agp {

    system("$scriptdir/make_agp_file.pl") && die "Couldn't run make_agp_file\n";
    print LOG " Make agp files for $WS_version\n";
    print LOG " =>'make_agp_file.pl'\n\n";
}

#################################################################################
# make_FTP_wormbase                                                             #
#################################################################################

sub make_FTP_wormbase {
    system ("$scriptdir/make_FTP_wormbase") && die "Couldn't run make_FTP_wormbase\n";
    print LOG " Move version to ftp-wormbase\n";
    print LOG " => 'make_FTP_wormbase\n\n";
}

#################################################################################
# make_anonymous_FTP
#################################################################################

sub make_anonymous_FTP {



}
 ########################################
 # Open logfile                         #
 ########################################

sub logfile_details {

print LOG "# autoace_minder\n\n";     
print LOG "# version        : $version\n";
print LOG "# run details    : $rundate $runtime\n";
print LOG "\n";
print LOG "WormBase version : WS${WS_version}\n";
print LOG "Wormpep version  : wormpep${WS_version}\n\n";

print LOG "======================================================================\n";
print LOG "  -a : Full WS release (executes all of the following -wbcp)\n"               if ($opt_a);
print LOG "  -i : Start an autoace build\n"                                              if ($opt_i);
print LOG "  -w : Write .acefiles from WormBase copies of the databases\n"               if ($opt_w);
print LOG "  -b : Build autoace\n"                                                       if ($opt_b);
print LOG "  -1 : Build autoace : DB only\n"                                             if ($opt_1);
print LOG "  -2 : Build autoace : DNA data\n"                                            if ($opt_2);
print LOG "  -3 : Build autoace : Release directory\n"                                   if ($opt_3);
print LOG "  -c : Check DB consistency and diffs from previous version\n"                if ($opt_c);
print LOG "  -p : Build wormpep database\n"                                              if ($opt_p);
print LOG "  -q : Running patch_pepace.pl and pepace2autoace\n"                          if ($opt_p);
print LOG "  -f : Move WS release to the ftp-wormbase site (WormBase private release)\n" if ($opt_f);
print LOG "  -z : Move WS release to the external FTP site (Full public release)\n"      if ($opt_z);
print LOG "  -d : Verbose/Debug mode\n"                                                  if ($opt_d);
print LOG "  -g : chromosome_dump.pl -g\n"                                               if ($opt_g);
print LOG "  -m : map PCR, RNAi and WTP\n"                                               if ($opt_m);
print LOG "  -y : make agp files for yellow brick road\n"                                if ($opt_y);
print LOG "======================================================================\n";
print LOG "\n";

}

#######################################################################
# Help and error trap outputs                                         #
#######################################################################

sub run_details {
    print "# autoace_minder\n\n";     
    print "# version        : $version\n";
    print "# run details    : $rundate $runtime\n";
    print "\n";
    print "WormBase version : WS${WS_version}\n";
    print "Wormpep version  : wormpep${WS_version}\n";
    print "\n";
    print "  -a : Full WS release (executes all of the following -wbcp)\n" if ($opt_a);
    print "  -w : Write .acefiles from WormBase copies of the databases\n" if ($opt_w);
    print "  -b : Build autoace\n" if ($opt_b);
    print "  -1 : Build autoace : DB only\n" if ($opt_1);
    print "  -2 : Build autoace : DNA data\n" if ($opt_2);
    print "  -3 : Build autoace : Release directory\n" if ($opt_3);
    print "  -c : Check DB consistency and diffs from previous version\n" if ($opt_c);
    print "  -p : Build wormpep database\n" if ($opt_p);
    print "  -f : Move WS release to the ftp-wormbase site (WormBase private release)\n" if ($opt_f);
    print "  -z : Move WS release to the external FTP site (Full public release)\n" if ($opt_z);
    print "  -d : Verbose/Debug mode\n" if ($opt_d);
    print "  -g : chromosome_dump.pl -g\n" if ($opt_g);
    print "  -m : map PCR, RNAi and WTP\n" if ($opt_m);
    print "  -y : make agp file for yellow brick road\n" if ($opt_y);
    print "\n\n";
}

sub usage {
    my $error = shift;

    if ($error == 1) {
	# No WormBase release number file
	print "The WormBase release number cannot be parsed\n";
	print "Check File: /wormsrv2/autoace/wspec/database.wrm\n\n";
	exit(0);
    }
    elsif ($error == 2) {
	# Abort unpack_db.pl script
	print "Abort unpack_db run.\n";
	print "\n\n";
	exit(0);
    }
    elsif ($error == 3) {
	# No last_version date for stlace
	print "Abort unpack_db run. stlace\n";
	print "\n\n";
	exit(0);
    }
    elsif ($error == 4) {
	# No last_version date for brigdb
	print "Abort unpack_db run. brigdb\n";
	print "\n\n";
	exit(0);
    }
    elsif ($error == 5) {
	# No last_version date for citace
	print "Abort unpack_db run. citace\n";
	print "\n\n";
	exit(0);
    }
    elsif ($error == 6) {
	# No last_version date for cshace
	print "Abort unpack_db run. cshace\n";
	print "\n\n";
	exit(0);
    }
    elsif ($error == 7) {
	# Check build prior to building
	print "You haven't built the database yet!\n";
	exit(0);
    }
    elsif ($error == 8) {
	# Check acefile dump prior to building
	print "You haven't written up-to-date .acefiles yet!\n";
	exit(0);
    }
    elsif ($error == 9) {
	# Check blat run
	print "You haven't run blat_them_all.\n";
	exit(0);
    }
    elsif ($error == 10) {
	# Build_in_progress flag already exists when build initiation attempted
	print "\nautoace build aborted:\n";
	print "The 'build_in_progress' flag already exists\n";
	print "You cannot start a new build until this flag is removed\n\n";
	exit(0);
    }
    elsif ($error == 11) {
	# Build_in_progress flag is newer than WormBase version number
	print "\nautoace build aborted:\n";
	print "The WS version predates the 'build_in_progress' flag \n";
	print "Check that the WS version number is correct\n\n";
	exit(0);
    }
    elsif ($error == 0) {
	# Normal help menu
	exec ('perldoc',$0);
    }
}


__END__

=pod

=head2   NAME - autoace_minder

=head1 USAGE

=over 4

=item autoace_minder [-options]

=back

autoace_minder is a wrapper to drive the various scripts utilised in the
build of a C.elegans WS database release.

autoace_minder mandatory arguments:

=over 4

=item none, (but it won\'t do anything)

=back

autoace_minder OPTIONAL arguments:

=over 4

=item -a, Full WS release (executes all of the following -wbcp)

=item -w, Write .acefiles from WormBase copies of the databases

=item -b, Build autoace : (performs options 1 & 2 below)

=item -1, Build autoace : Database only

=item -2, Build autoace : Dump DNA

=item -3, Build autoace : release directory

=item -c, Check DB consistency and diffs from previous version

=item -p, Build wormpep database

=item -f, Move WS release to the ftp-wormbase site (WormBase private release)

=item -z, Move WS release to the external FTP site (Full public release)

=item -d, Verbose/Debug mode

=item -g, dump GFF files

=item -m, map PCR, RNAi and WTP

=back

=cut
