#!/usr/local/bin/perl -w
#
# autoace_minder
# v 0.3
#
# dl
#
# Usage : autoace_minder [-options]
#


# v0.3
# 001110 : dl  : Added 'test_dna_dump' into the DNA dump sub
#              : This is a fatal exit if any .dna file is zero length
# 010307 : dl  : Mended system call for wormpep build

# v0.2 
# 001109 : dl  : Added 'dbcomp' into the check subroutine
# 001020 : dl  : Modified '-2' option to just dump the DNA
#              : simpler and quicker for checking 
#              : still run full DNA/GFF dump as part of the -b build

# v0.1
# 001006 : ag3 : fixed variable WS_version
# 000926 : dl  : PP version

#################################################################################
# Initialise variables                                                          #
#################################################################################

$|=1;
use IO::Handle;
use Getopt::Std;
use lib "/wormsrv2/scripts/";
use Wormbase;


 ##############################
 # Script variables (run)     #
 ##############################

my $maintainers = "dl1\@sanger.ac.uk krb\@sanger.ac.uk kj2\@sanger.ac.uk";
my $rundate = `date +%y%m%d`; chomp $rundate;
my $runtime = `date +%H:%M:%S`; chomp $runtime;
# grab version number from cvs
my $version = &get_cvs_version("$0");

 ##############################
 # command-line options       #
 ##############################

$opt_a="";   # Full release (does all the following)
$opt_w="";   # Write .acefiles
$opt_b="";   # Build autoace 
$opt_1="";   # Build autoace : DB only
$opt_2="";   # Build autoace : CHROMOSOMES directory
$opt_3="";   # Build autoace : Release directory
$opt_c="";   # Check DB consistency
$opt_p="";   # Build wormpep
$opt_f="";   # Wormbase release to FTP site
$opt_z="";   # Public release to FTP site
$opt_d="";   # Verbose debug mode
$opt_h="";   # Help/Usage page

getopts ('awbchpfzdrg123');
&usage(0) if ($opt_h);

# specify location of scripts
$scriptdir = "/wormsrv2/scripts";

#################################################################################
# Get the WS version number and set the wormpep release number                  #
#################################################################################

# grab version as a string, e.g. WSxx
$Wormbase_release_version = &get_wormbase_version;

&usage(1) if (!defined($Wormbase_release_version));

# get just the number
$WS_version = substr ($Wormbase_release_version,2);

$WS_previous = $WS_version -1;
$WP_version = $WS_version + 10;

 ########################################
 # if all then set all flags            #
 ########################################

if ($opt_a) {
    $opt_w = 1; $opt_b = 1; $opt_c = 1; $opt_p = 1;
}

 ########################################
 # Open logfile                         #
 ########################################

my $logfile = "/wormsrv2/logs/autoace_minder.WS${WS_version}.${rundate}.$$";
open (LOG,">$logfile");
LOG->autoflush();

print LOG "# autoace_minder\n\n";     
print LOG "# version        : $version\n";
print LOG "# run details    : $rundate $runtime\n";
print LOG "\n";
print LOG "WormBase version : WS${WS_version}\n";
print LOG "Wormpep version  : wormpep${WP_version}\n\n";

print LOG "======================================================================\n";
print LOG "  -a : Full WS release (executes all of the following -wbcp)\n" if ($opt_a);
print LOG "  -w : Write .acefiles from WormBase copies of the databases\n" if ($opt_w);
print LOG "  -b : Build autoace\n" if ($opt_b);
print LOG "  -1 : Build autoace : DB only\n" if ($opt_1);
print LOG "  -2 : Build autoace : DNA data\n" if ($opt_2);
print LOG "  -3 : Build autoace : Release directory\n" if ($opt_3);
print LOG "  -c : Check DB consistency and diffs from previous version\n" if ($opt_c);
print LOG "  -p : Build wormpep database\n" if ($opt_p);
print LOG "  -f : Move WS release to the ftp-wormbase site (WormBase private release)\n" if ($opt_f);
print LOG "  -z : Move WS release to the external FTP site (Full public release)\n" if ($opt_z);
print LOG "  -d : Verbose/Debug mode\n" if ($opt_d);
print LOG "======================================================================\n";
print LOG "\n";

#################################################################################
# Main Loop                                                                     #
#################################################################################

&make_acefiles      if ($opt_w);
&make_autoace       if ($opt_b);
&make_DB            if ($opt_1);
&make_DNA           if ($opt_2);
&make_release       if ($opt_3);
&check_release      if ($opt_c);
&make_wormpep       if ($opt_p);
&make_FTP_wormbase  if ($opt_f);
&make_anonymous_FTP if ($opt_z);

 ##############################
 # mail $maintainer report    #
 ##############################

close LOG;

open (mailLOG, "|/usr/bin/mailx -s \"WormBase Report: autoace_minder\" $maintainers ");
open (readLOG, "<$logfile");
while (<readLOG>) {
    print mailLOG $_;
}
close readLOG;
close mailLOG;

 ##############################
 # hasta luego                #
 ##############################

exit(0);



#################################################################################
### Subroutines                                                               ###
#################################################################################



#################################################################################
# make_acefiles                                                                 #
#################################################################################

sub make_acefiles {
    system ("$scriptdir/make_acefiles -nep") && die "Couldn't run make_acefiles\n";
    print LOG " Write acefiles to disk\n";
    print LOG " => 'make_acefiles -nep'\n\n";
}

#################################################################################
# make_autoace                                                                  #
#################################################################################

sub make_autoace {
    system ("$scriptdir/make_autoace -p /wormsrv2/autoace -rdc") && die "Couldn't run autoace -rdc\n";
    print LOG " Build full autoace (database/CHROMOSOMES/release)\n";
    print LOG " =>'make_autoace -p /wormsrv2/autoace -rdc'\n\n";
}

sub make_DB {
    system ("$scriptdir/make_autoace -p /wormsrv2/autoace -r") && die "Couldn't run autoace -r\n" ;
    print LOG " Build autoace (database)\n";
    print LOG " => 'make_autoace -p /wormsrv2/autoace -r'\n\n";
}

sub make_DNA {
    system ("$scriptdir/dna_dump /wormsrv2/autoace")  && die "Couldn't run autoace\n";
    print LOG " Build autoace (CHROMOSOMES)\n";
    print LOG " =>'dna_dump /wormsrv2/autoace'\n\n";

#    system ("$scriptdir/test_dna_dump /wormsrv2/autoace/CHROMOSOMES");
#    print LOG " test chromosomal DNA dumps\n";
#    print LOG " =>'test_dna_dump /wormsrv2/autoace/CHROMOSOMES'\n\n";
}

sub make_release {
    system ("$scriptdir/make_autoace -p /wormsrv2/autoace -d")  && die "Couldn't run autoace -d\n"; 
    print LOG " Build autoace (release)\n";
    print LOG " => 'make_autoace -p /wormsrv2/autoace -d'\n\n";
}

#################################################################################
# check_release                                                                 #
#################################################################################

sub check_release {


#    system ("$scriptdir/test_make_autoace -n /wormsrv2/autoace -o /wormsrv2/$olddb -cd");
#    print LOG " Test database build\n";
#    print LOG " => 'test_make_autoace -n /wormsrv2/autoace -o /wormsrv2/$olddb -cd'\n\n";

    system ("$scriptdir/dbcomp -f /wormsrv2/WS${WS_previous}") && die "Couldn't run dbcomp -f\n";
    print LOG " Make dbcomp report\n";
    print LOG " => 'dbcomp -f /wormsrv2/WS${WS_previous}'\n\n";

}

#################################################################################
# make_wormpep                                                                  #
#################################################################################

sub make_wormpep {
    system ("$scriptdir/make_wormpep -r $WP_version") && die "Couldn't run make_wormpep -r\n";
    print LOG " Build wormpep release $WP_version\n";
    print LOG " =>'make_wormpep -r $WP_version'\n\n";
}

#################################################################################
# make_FTP_wormbase                                                             #
#################################################################################

sub make_FTP_wormbase {
    system ("$scriptdir/make_FTP_wormbase") && die "Couldn't run make_FTP_wormbase\n";
    print LOG " Move version to ftp-wormbase\n";
    print LOG " => 'make_FTP_wormbase\n\n";
}

#################################################################################
# make_anonymous_FTP
#################################################################################

sub make_anonymous_FTP {



}


#######################################################################
# Help and error trap outputs                                         #
#######################################################################

sub run_details {
    print "# autoace_minder\n\n";     
    print "# version        : $version\n";
    print "# run details    : $rundate $runtime\n";
    print "\n";
    print "WormBase version : WS${WS_version}\n";
    print "Wormpep version  : wormpep${WP_version}\n";
    print "\n";
    print "  -a : Full WS release (executes all of the following -wbcp)\n" if ($opt_a);
    print "  -w : Write .acefiles from WormBase copies of the databases\n" if ($opt_w);
    print "  -b : Build autoace\n" if ($opt_b);
    print "  -1 : Build autoace : DB only\n" if ($opt_1);
    print "  -2 : Build autoace : DNA data\n" if ($opt_2);
    print "  -3 : Build autoace : Release directory\n" if ($opt_3);
    print "  -c : Check DB consistency and diffs from previous version\n" if ($opt_c);
    print "  -p : Build wormpep database\n" if ($opt_p);
    print "  -f : Move WS release to the ftp-wormbase site (WormBase private release)\n" if ($opt_f);
    print "  -z : Move WS release to the external FTP site (Full public release)\n" if ($opt_z);
    print "  -d : Verbose/Debug mode\n" if ($opt_d);
    print "\n\n";
}

sub usage {
    my $error = shift;

    if ($error == 1) {
	# No WormBase release number file
	print "The WormBase release number cannot be parsed\n";
	print "Check File: /wormsrv2/autoace/wspec/database.wrm\n\n";
	&run_details;
	exit(0);
    }
    elsif ($error == 0) {
	# Normal help menu
	exec ('perldoc',$0);
    }
}


__END__

=pod

=head2   NAME - autoace_minder

=head1 USAGE

=over 4

=item autoace_minder [-options]

=back

autoace_minder is a wrapper to drive the various scripts utilised in the
build of a C.elegans WS database release.

autoace_minder mandatory arguments:

=over 4

=item none, (but it won't do anything)

=back

autoace_minder OPTIONAL arguments:

=over 4

=item -a, Full WS release (executes all of the following -wbcp)

=item -w, Write .acefiles from WormBase copies of the databases

=item -b, Build autoace

=item -1, Build autoace : Database only

=item -2, Build autoace : Dump DNA

=item -3, Build autoace : release directory

=item -c, Check DB consistency and diffs from previous version

=item -p, Build wormpep database

=item -f, Move WS release to the ftp-wormbase site (WormBase private release)

=item -z, Move WS release to the external FTP site (Full public release)

=item -d, Verbose/Debug mode

=back

=cut
