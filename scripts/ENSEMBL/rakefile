# this Rakefile is to run the compara pipeline
# including dumping and packaging a tarball of the databases
# it requires rake to run

# major advantage is the shared configuration file across quite
# a few PERL scripts and the management through rake
# 


require 'yaml'
require 'fileutils'

tmp_place = '/lustre/scratch101/ensembl/wormpipe/compara_build'
perl='/software/worm/perl_510/bin/perl'
basedir='/software/worm/ensembl'

# check to see if the old build was cleaned
# will raise an error if not
desc 'check if the directories are cleaned up'
task :check_clean do
	files=Dir.glob('/lustre/scratch101/ensembl/wormpipe/compara/Caenorhabditis* /lustre/scratch101/ensembl/wormpipe/compara/Brugia*  /lustre/scratch101/ensembl/wormpipe/compara/Pristionchus*')
	raise("the last run was not cleaned up! delete:\n#{files.join("\n")}") unless files.size == 0
end

# that is the basic environment setup task
# on which most other tasks depend on
desc 'setup environment variables'
task :env_setup do
        old_perl5=ENV['PERL5LIB']
        additional='/software/worm/lib/perl5:/software/worm/lib/bioperl-run_last_cvs/:/software/worm/ensembl/ensembl-config/celegans/generic-elegans:/software/worm/ensembl/ensembl-pipeline/modules:/software/worm/ensembl/ensembl-analysis/modules:/software/worm/ensembl/bioperl-live:/software/worm/ensembl/bioperl-run:/software/worm/ensembl/ensembl/modules:/software/worm/ensembl/ensembl-hive/modules:/software/worm/ensembl/ensembl-compara/modules:/software/worm/ensembl/ensembl-analysis:/software/worm/lib:.'
        ENV['PERL5LIB']=additional+old_perl5
end

# updates the C.elegans assembly version to the current build
desc 'update the configuration file'
task :update_conf do
  yml_file='etc/ensembl_lite.conf'
	yml=YAML::load_file(yml_file)
	yml['elegans']['version']="WS#{Dir.glob("/nfs/disk100/wormpub/DATABASES/WS*").sort[-2].scan(/\d+/)[-1].to_i+1}"
	File.open(yml_file,'w') do |out|
		YAML.dump(yml,out)
	end
end

##############################
# setup of the core databases
#

# small shorthand
def build_db(db_name)
	sh "/software/bin/perl scripts/worm_lite.pl -species #{db_name} -setup -load_dna -load_gene"
end

desc 'build elegans database'
task :build_elegans => [:env_setup] do
	build_db(:elegans)
end

desc 'build briggsae database'
task :build_briggsae => [:env_setup] do
	build_db(:briggsae)
end

desc 'build brenneri database'
task :build_brenneri => [:env_setup] do
	build_db(:brenneri)
end

desc 'build remanei database'
task :build_remanei => [:env_setup] do
	build_db(:remanei)
end

desc 'build remanei test database'
task :build_remanei_test => [:env_setup] do
	build_db(:remanei_test)
end

desc 'build brugia database'
task :build_brugia => [:env_setup] do
	build_db(:brugia)
end

desc 'build briggsae test database'
task :build_briggsae_test => [:env_setup] do
	build_db(:briggsae_test)
end

desc 'build pristionchus database'
task :build_pristionchus => [:env_setup] do
	build_db(:pristionchus)
end

desc 'build japonica database'
task :build_japonica => [:env_setup] do
	build_db(:japonica)
end

##############################################
# setup of the compara databases
# - note the hardcoded paths to the sql-files
#

desc 'build homology database'
task :build_homology => [:env_setup] do
  conf='etc/compara-genetree-9.conf'
  reg='etc/compara_test9.reg'
  yml=YAML::load_file('etc/ensembl_lite.conf')
  db=yml['elegans']['database']

  # base db+schema
  sh "mysql -h #{db['host']} -P#{db['port']} -u #{db['user']} -p#{db['password']} -e 'DROP DATABASE IF EXISTS worm_compara;CREATE DATABASE worm_compara;'"
  sh "cat #{basedir}/ensembl-compara/sql/table.sql #{basedir}/ensembl-hive/sql/tables.sql #{basedir}/ensembl-compara/sql/pipeline-tables.sql |mysql -h #{db['host']} -P#{db['port']} -u #{db['user']} -p#{db['password']} worm_compara"

  # taxonomy
  sh "bzcat #{basedir}/compara-conf/ncbi_taxon.sql.bz2 |mysql -h #{db['host']} -P#{db['port']} -u #{db['user']} -p#{db['password']} worm_compara"

  # load logics
  sh "#{perl} #{basedir}/ensembl-compara/scripts/pipeline/comparaLoadGenomes.pl -conf #{conf}"
  sh "#{perl} #{basedir}/ensembl-compara/scripts/pipeline/loadGeneTreeSystem.hcluster.pl -conf #{conf}"
  
  # table hacks
  protein_treesql=%q/'INSERT INTO method_link (type, class) VALUES ("ENSEMBL_ORTHOLOGUES","Homology.homology"),("ENSEMBL_PARALOGUES","Homology.homology"),("PROTEIN_TREES","ProteinTree.protein_tree_node")'/
  sh "mysql -h #{db['host']} -u #{db['user']} -p#{db['password']} worm_compara -e #{protein_treesql}"

  nj_treesql=%q/'INSERT INTO protein_tree_tag (tag,value) VALUES ("species_tree_string","((((((((6238*,31234)a,135651)b,6239*)c,281687)d,54126)e,6305)f,6289)g,6279)h;")'/
  sh "mysql -h #{db['host']} -u #{db['user']} -p#{db['password']} worm_compara -e #{nj_treesql}"

  # MLSS setup
  # For orthologues
  sh "#{perl} #{basedir}/ensembl-compara/scripts/pipeline/create_mlss.pl --f --pw --reg_conf #{reg} --method_link_type ENSEMBL_ORTHOLOGUES --genome_db_id '1,2,3,4,5,6,7,8,9'"

  # For between-species paralogues
  sh "#{perl} #{basedir}/ensembl-compara/scripts/pipeline/create_mlss.pl --f --pw --reg_conf #{reg} --method_link_type ENSEMBL_PARALOGUES --genome_db_id '1,2,3,4,5,6,7,8,9'"

  # For same-species paralogues
  sh "#{perl} #{basedir}/ensembl-compara/scripts/pipeline/create_mlss.pl --f --sg --reg_conf #{reg} --method_link_type ENSEMBL_PARALOGUES --genome_db_id '1,2,3,4,5,6,7,8,9'"

  # For protein trees
  sh "#{perl} #{basedir}/ensembl-compara/scripts/pipeline/create_mlss.pl --f --reg_conf #{reg} --method_link_type PROTEIN_TREES --genome_db_id '1,2,3,4,5,6,7,8,9'"

  # up the failure tolerance

  def up_error_for_analysis(db,analysis)
      error_sql=%Q/'UPDATE analysis_stats SET failed_job_tolerance = 20 WHERE analysis_id=(SELECT analysis_id FROM analysis WHERE logic_name = "#{analysis}");'/
      sh "mysql -h #{db['host']} -u #{db['user']} -p#{db['password']} worm_compara -e #{error_sql}"
  end

  up_error_for_analysis(db,'MCoffee')
  up_error_for_analysis(db,'OrthoTree')
  up_error_for_analysis(db,'QuickTreeBreak')

end

desc 'build PECAN database'
task :build_pecan => [:env_setup] do
  conf='etc/pecan_test.conf'
	yml=YAML::load_file('etc/ensembl_lite.conf')
  db=yml['elegans']['database']

	sh "mysql -h #{db['host']} -P#{db['port']} -u #{db['user']} -p#{db['password']} -e 'DROP DATABASE IF EXISTS worm_compara_pecan;CREATE DATABASE worm_compara_pecan;'"
	sh "cat #{basedir}/ensembl-hive/sql/tables.sql #{basedir}/ensembl-compara/sql/table.sql #{basedir}/ensembl-compara/sql/pipeline-tables.sql |mysql -h #{db['host']} -u #{db['user']} -p#{db['password']} worm_compara_pecan"
	
	sh "bzcat #{basedir}/compara-conf/ncbi_taxon.sql.bz2 |mysql -h #{db['host']} -u #{db['user']} -p#{db['password']} worm_compara_pecan"
	
	sh "#{perl} #{basedir}/ensembl-compara/scripts/pipeline/comparaLoadGenomes.pl -conf #{conf}"
	sh "#{perl} #{basedir}/ensembl-compara/scripts/pipeline/loadMultipleAlignerSystem.pl -conf #{conf}"
	
end

##########################
# run the beehive
#

# hive shorthand
def run_beehive(db_name,perl,basedir)
	yml=YAML::load_file('etc/ensembl_lite.conf')
        db=yml['elegans']['database'] # lets default to elegans for dbconnection details

	# sh %Q(#{perl} #{basedir}/ensembl-hive/scripts/beekeeper.pl -url mysql://#{db['user']}:#{db['password']}@#{db['host']}:#{db['port']}/#{db_name} -loop -lsf_option '-R"rusage[myia64b=10:duration=10:decay=1] select[myia64b<400]" -W 120')
	sh "#{perl} #{basedir}/ensembl-hive/scripts/beekeeper.pl -url mysql://#{db['user']}:#{db['password']}@#{db['host']}:#{db['port']}/#{db_name} -loop" # axe the old ressouce stuff
end


desc 'run homology beehive'
task :run_homology => [:env_setup] do
	run_beehive('worm_compara',perl,basedir)
end

desc 'run pecan beehive'
task :run_pecan => [:env_setup] do
	run_beehive('worm_compara_pecan',perl,basedir)
end


#####################################
# dump data and copy it around
#

desc 'dump homology ace file'
task :dump_homology => [:env_setup] do
	puts "making #{tmp_place}/compara"
	FileUtils.mkdir_p("#{tmp_place}/compara")
	sh "/software/bin/perl scripts/get_all_elegans_orthologues.pl > #{tmp_place}/compara.ace"
end

desc 'dump conservation wiggle files'
task :dump_gerp =>[:env_setup] do

	['elegans','briggsae','brenneri','remanei','japonica','pristionchus','brugia','Mhapla','Mincognita','Hcontortus'].each{|species|
	  spec_dir= "#{tmp_place}/compara/#{species}"
	  FileUtils.mkdir_p(spec_dir)
          sh "#{perl} scripts/getConservationScores.pl -species #{species} -o #{spec_dir}/#{species}.wig"
          
	  # split it
          sh "#{perl} ~mh6/tmp/split_wig.pl #{spec_dir}/#{species}.wig" # change the location of the splitter
	  File.unlink("#{spec_dir}/#{species}.wig")

	  # wiblification
          FileList["#{spec_dir}/#{species}.wig*"].each{|f|
		  # wiblify it
		  system("#{perl} ../wiggle2gff3.pl --trackname gerp --method syntheny --source gerp --path=#{spec_dir} #{f} >> #{spec_dir}/#{species}_gerp.gff3")
		  File.unlink(f)

		  # path munglification
	  }

	  # archive it
	  currentDir=FileUtils.pwd
	  FileUtils.cd("#{tmp_place}/compara")
	  sh "tar cvSf #{species}_gerp.tar #{species}"
	  FileUtils.remove_dir(spec_dir,true)
          sh "pbzip2 -9  #{species}_gerp.tar"
	  FileUtils.cd(currentDir)
	}
end

desc 'dump pecan files'
task :dump_pecan => [:env_setup] do
	FileUtils.mkdir_p("#{tmp_place}/compara")
 
 	ENV['ENSEMBL_REGISTRY'] = './etc/E_registry.pl'

	sh "#{perl} scripts/getsynteny.pl > #{tmp_place}/compara/pecan.gff"   # dump gff

#	['I','II','III','IV','V','X'].each {|c|
	   sh "#{perl} scripts/dump_all_clustal.pl > #{tmp_place}/compara/pecan.clw" # dump clustal
#	}
end

desc "make a compara tarball"
task :dump_compara do
	conf=YAML.load_file('etc/ensembl_lite.conf')

	#mysqldir=''
	#dump_options='--add-drop-table -u wormro -a -h ia64d'

	# to_dump =[ 'briggsae','elegans','remanei','brenneri','brugia']

	########### if needed, commment out the mysql dumping part #####
	#FileUtils.mkdir_p("#{tmp_place}/compara")
	#FileUtils.cd("#{tmp_place}/compara") do
	#	conf.each_key{|org|
	#		next unless to_dump.include?(org)
	#		db=conf[org]['database']
	#		file="#{db['dbname']}.sql"
	#		sh "#{mysqldir}mysqldump #{dump_options} -B #{db['dbname']} > #{file}"
	#	}
	#	sh "#{mysqldir}mysqldump #{dump_options} -B worm_compara > worm_compara.sql"
	#	sh "#{mysqldir}mysqldump #{dump_options} -B worm_compara_lagan > worm_compara_lagan.sql"
	#end
	# # # # # # # # # # # # # # # #
	
	FileUtils.cd(tmp_place) do
		File.unlink("compara.tar.bz2") if File.exists?("compara.tar.bz2")
		sh "tar cvf compara.tar compara/*"
		sh "bzip2 -9 compara.tar"
		FileList['compara/*'].each{|f|File.unlink(f)}
	end
end

desc 'copy release files'
task :copy_release do
	target_dir='/nfs/disk100/wormpub/BUILD/autoace/'
	cp "#{tmp_place}/compara.ace","#{target_dir}acefiles/"
	cp "#{tmp_place}/compara.tar.bz2",target_dir
end



#################
# final cleanup
#

desc 'cleanup the compara work directories'
task :cleanup do
	sh 'rm -rf /lustre/scratch101/ensembl/wormpipe/compara/logs/*'      # remove the logs
	sh 'rm -f /lustre/scratch101/ensembl/wormpipe/compara/Caenorhabditis*' # remove the blast databases
	sh 'rm -f /lustre/scratch101/ensembl/wormpipe/compara/Brugia*' # remove the blast databases
	sh 'rm -f /lustre/scratch101/ensembl/wormpipe/compara/Pristionchus*' # remove the blast databases
	sh "rm -f #{tmp_place}/compara.ace" # remove the compara ace file
	sh "rm -rf #{tmp_place}/compara"    # remove the compara dump directory
end

desc 'build and setup all databases'
task :build => [:check_clean,:env_setup,:build_homology,:run_homology,:build_pecan,:run_pecan,:cleanup]

desc 'dump all databases into the various flatfiles'
task :dump => [:dump_homology,:dump_pecan,:dump_compara,:copy_release,:cleanup]

desc 'hack around some of the more recent bugs in compara (build and run bit)'
task :mt3_run => [:check_clean,:env_setup,:build_homology,:run_homology]

desc 'hack around some of the more recent bugs in compara (dump)'
task :mt3_dump => [:dump_homology,:dump_compara,:copy_release,:cleanup] 

# task :default => [:update_conf,:build,:dump]
task :default => [:update_conf,:mt3_run]
