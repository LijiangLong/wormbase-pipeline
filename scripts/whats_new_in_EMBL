#!/usr/local/bin/perl5.6.1 -w
#
# whats_new_in_EMBL
#
# dl
#
# checks EMBL for new EST or mRNA entries
#
# Last updated by: $Author: dl1 $                      
# Last updated on: $Date: 2003-01-13 14:07:19 $        

$|=1;
use strict;
use Getopt::Long;
use lib "/wormsrv2/scripts/";   
use Wormbase;

 ##############################
 # Variables                  #
 ##############################

my $maintainers = "All";
my $rundate     = `date +%y%m%d`; chomp $rundate;
my $name;

# touch logfile for run details
if ($0 =~ /\//) {($name) = $0 =~ m/\/([^\/]+)$/;}
else {$name = $0;}
system ("touch /wormsrv2/logs/history/$name.`date +%y%m%d`");
my $logfile = "/wormsrv2/logs/whats_new_in_EMBL.$rundate.$$";
	   
 ##############################
 # command-line options       #
 ##############################
	   
my $help;       # Help perdoc
my $debug;      # Debug mode, verbose output to dl1 only
my $days;       # No. of days to check for new entries

GetOptions (
            "debug=s"   => \$debug,
            "help"      => \$help,
	    "days=s"    => \$days
            );

# help page	   
&usage("Help") if ($help);
	   
# no debug name
if($debug){
  print "DEBUG = \"$debug\"\n\n";
  ($maintainers = $debug . '\@sanger.ac.uk');
}

# use default value of 14 for $days
$days = 14 if (!$days);

# run variables
my $date     = &get_8figure_date($days);
my $new_mRNA = 0;
my $new_EST  = 0;

 ########################################
 # Open logfile                         #
 ########################################

system ("/bin/touch $logfile");
open (LOG,">>$logfile") or die ("Could not create logfile\n");

# mRNA entries
open (NEW_SEQUENCES, "/usr/local/pubseq/bin/getz -c \'([emblnew-Division:inv] & [emblnew-Molecule:rna] & [emblnew-org:caenorhabditis elegans*] & [emblnew-DateCreated#$date:]) | ([emblrelease-Division:inv] & [emblrelease-Molecule:rna] & [emblrelease-org:caenorhabditis elegans*] & [emblrelease-DateCreated#$date:])\' |");

while (<NEW_SEQUENCES>){
    chomp;
    $new_mRNA = $_;
}
close NEW_SEQUENCES;

print "There are $new_mRNA new mRNA entries since $date\n" if ($debug);

# EST entries
open (NEW_SEQUENCES, "/usr/local/pubseq/bin/getz -c \'([emblnew-Division:est] & [emblnew-Molecule:rna] & [emblnew-org:caenorhabditis elegans*] & [emblnew-DateCreated#$date:]) | ([emblrelease-Division:est] & [emblrelease-Molecule:rna] & [emblrelease-org:caenorhabditis elegans*] & [emblrelease-DateCreated#$date:])\' |");
while (<NEW_SEQUENCES>){
    chomp;
    $new_EST = $_;
}
close NEW_SEQUENCES;

print "There are $new_EST new EST entries since $date\n" if ($debug);

 ##############################
 # mail $maintainer report    #
 ##############################

print LOG "# whats new in EMBL?\n";
print LOG "# run details     : $rundate\n";
print LOG "\n";
print LOG "EMBL entries created since $date\n";
print LOG "There are $new_mRNA new mRNA entries\n";
print LOG "There are $new_EST new EST entries\n\n";
close LOG;

&mail_maintainer("WormBase Report: whats new in EMBL",$maintainers,$logfile);


##############################
# a extremidade              #
##############################

exit(0);

##############################
# subroutines                #
##############################


sub get_8figure_date {
    my $days = shift;
    
    my %month2num = (
		  'Jan' => '01',
		  'Feb' => '02',
		  'Mar' => '03',
		  'Apr' => '04',
		  'May' => '05',
		  'Jun' => '06',
		  'Jul' => '07',
		  'Aug' => '08',
		  'Sep' => '09',
		  'Oct' => '10',
		  'Nov' => '11',
		  'Dec' => '12'
		  );

    
    my $t = time - ($days * 86400);
    my $play = scalar localtime $t;
    my ($month,$day,$year) = $play =~ (/\S+\s+(\S+)\s+(\d+)\s+\S+\s+(\d+)/);
    
    my $date = $year . $month2num{$month};
    ($date .= "0") if ($day < 10);
    $date .= $day;
    
    return ($date);
}

###############################
# Prints help and disappears  #
###############################

sub usage {
    my $error = shift;

    if ($error eq "Help") {
        # Normal help menu
        system ('perldoc',$0);
        exit (0);
    }
}



__END__

=pod

=head1 NAME 

whats_new_in_EMBL

=head2 USAGE

whats_new_in_EMBL [-options]

whats_new_in_EMBL will return the number of created entries in EMBL since
a given number of days ago (default value is 14 days). Both mRNA and EST
entries are calculated.

whats_new_in_EMBL MANDATORY arguments:

=over 4

=item none

=back

whats_new_in_EMBL OPTIONAL arguments:

=item B<-days [int]>, No. of days to check for (default value is 14)

=item B<-debug [username]>, Verbose/debug mode

=item B<-help>, Help

=head2 Dependencies

no dependencies.

=head2 AUTHOR

Dan Lawson (B<dl1@sanger.ac.uk>)

=cut
