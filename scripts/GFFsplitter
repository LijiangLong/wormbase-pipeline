#!/usr/local/bin/perl5.6.0 -w
#
# GFFsplitter
# 
# Usage GFFsplitter [-options]
# 
# dl
#
# Last updated by: $Author: dl1 $
# Last updated on: $Date: 2002-08-22 13:51:52 $

#################################################################################
# variables                                                                     #
#################################################################################

$|=1;
use IO::Handle;
use Getopt::Long;
use lib '/wormsrv2/scripts';
use Wormbase;
use strict;

 ##############################
 # Script variables (run)     #
 ##############################

my $maintainers = "All";
my $rundate = `date +%y%m%d`; chomp $rundate;
my $runtime = `date +%H:%M:%S`; chomp $runtime;
my $WS_version = &get_wormbase_version_name;

 ##############################
 # Paths etc                  #
 ##############################

my $datadir = "/wormsrv2/autoace/GFF_SPLITS";

# create GFF_SPLITS subdirectory if it doesn't already exist
if (! -e "/wormsrv2/autoace/GFF_SPLITS/GFF_SPLITS"){
  system("mkdir /wormsrv2/autoace/GFF_SPLITS/GFF_SPLITS") && die "Couldn't create directory\n";
}

 ##############################
 # command-line options       #
 ##############################

my $help;      # Help/Usage page
my $archive;   # archive GFF_splits directory into a WSxx directory
my $silent;    # silent running
my $debug;     # debug

GetOptions (
	    "help"      => \$help,
	    "archive"   => \$archive,
	    "silent"    => \$silent,
	    "debug"     => \$debug
	    );

# help 
&usage if ($help);

# debug mode modifies $maintainers to reduce e-mail load
($maintainers = "dl1\@sanger.ac.uk") if ($debug);

##########################################################
# Archive the GFF_splits directory into a WSxx directory
##########################################################

# runs only if -a is specified
if($archive){
    print "Renaming $datadir/GFF_SPLITS to $datadir/$WS_version\n";
    system("mv $datadir/GFF_SPLITS ${datadir}/${WS_version}") && die "Couldn't rename directory\n";
    exit(0);
}

 ########################################
 # Open logfile                         #
 ########################################

my $logfile = "/wormsrv2/logs/GFFsplitter.$rundate.$$";
open (LOG,">$logfile");
LOG->autoflush();

print LOG "# GFFsplitter\n\n";     
print LOG "# run details    : $rundate $runtime\n";
print LOG "\n";

#################################################################################
# Main Loop                                                                     #
#################################################################################


# prepare array of file names and sort names
our @files = (
	      'CHROMOSOME_I',
	      'CHROMOSOME_II',
	      'CHROMOSOME_III',
	      'CHROMOSOME_IV',
	      'CHROMOSOME_V',
	      'CHROMOSOME_X',
	      );

our @gff_files = sort @files; 
undef @files; 

our @gff_classes;

# prepare array of data types to dump
READARRAY:   while (<DATA>) {
    chomp $_;
    last READARRAY if $_ =~ /END/;
    push (@gff_classes,$_);
}


############################################################
# loop through each GFF file                               #
############################################################

our $debug = 1;
my %GFF;
my $file;

foreach $file (@gff_files) {
    
    next if ($file eq "");
    
    print LOG "# File $file\n";
    print     "# File $file\n" if ($debug);

    my $line_count = 0;

    #########################################################
    # open the gff file                                     #
    #########################################################
    
    my $running_total = 0;
    my ($name,$feature,$method,$start,$stop,$score,$strand,$other);
    my @header = "";

    open (GFF, "</wormsrv2/autoace/CHROMOSOMES/$file.gff");
    while (<GFF>) {
	chomp;
	$line_count++;
	
	print "." if (($line_count % 5000) == 0);

	#skip header lines of file
	if (/^\#/) {push (@header,$_); next;}

	($name,$method,$feature,$start,$stop,$score,$strand,$other,$name) = split /\t/;

	# Clone path
	if (($method eq "Genomic_canonical") 
	    && ($feature eq "Sequence"))                  {push ( @{$GFF{$file}{clone_path}},$_);}
	# Genes     
	elsif ( (($method eq "curated") 
		 && ($feature eq "Sequence")) 
		|| (($method eq "provisional")
		    && ($feature eq "Sequence")) 
		|| (($method eq "tRNAscan-SE-1.11")
		    && ($feature eq "Sequence")) )        {push (@{$GFF{$file}{genes}},$_);}
	elsif ( ($method eq "Pseudogene") 
		&& ($feature eq "Sequence"))              {push (@{$GFF{$file}{pseudogenes}},$_);}
	# RNA genes 
	elsif ((($method eq "RNA") 
		|| ($method eq "tRNAscan-SE-1.11")) 
	       && ($feature eq "Sequence"))               {push (@{$GFF{$file}{rna}},$_);}
	# CDS Exon  
	elsif ( (($method eq "curated") || 
                 ($method eq "provisional")) 
		&& ($feature eq "CDS"))                   {push (@{$GFF{$file}{CDS_exon}},$_);}
	# Exon      
	elsif ((($method eq "curated") 
		|| ($method eq "provisional")) 
	       && ($feature eq "exon"))                   {push (@{$GFF{$file}{exon}},$_);}
       	elsif (($method eq "tRNAscan-SE-1.11") 
	       && ($feature eq "exon"))                   {push (@{$GFF{$file}{exon_tRNA}},$_);}
	elsif (($method eq "Pseudogene") 
	       && ($feature eq "exon"))                   {push (@{$GFF{$file}{exon_pseudogene}},$_);}
	# Intron    
	elsif ((($method eq "curated") 
		|| ($method eq "provisional")) 
	       && ($feature eq "intron"))                 {push (@{$GFF{$file}{intron}},$_);}
	elsif (($method eq "tRNAscan-SE-1.11") 
	       && ($feature eq "intron"))                 {push (@{$GFF{$file}{intron_tRNA}},$_);}
	elsif (($method eq "Pseudogene") 
	       && ($feature eq "intron"))                 {push (@{$GFF{$file}{intron_pseudogene}},$_);}
	# Intron confirmed by ESTs
	elsif (/Confirmed_by_EST/)                        {push (@{$GFF{$file}{intron_confirmed_CDS}},$_);}
	elsif (/Confirmed_by_cDNA/)                       {push (@{$GFF{$file}{intron_confirmed_CDS}},$_);}
	elsif (/Confirmed_in_UTR/)                        {push (@{$GFF{$file}{intron_confirmed_UTR}},$_);}
        # Repeats
	elsif (($method eq "tandem") 
            || ($method eq "inverted") 
            || ($method eq "hmmfs.3") 
            || ($method eq "scan") 
            || ($feature eq "repeat_region"))             {push (@{$GFF{$file}{repeats}},$_);}
   	# TC1 insertions
	elsif ($method eq "BLASTN_TC1")                   {push (@{$GFF{$file}{tc_insertions}},$_);}
   	# Protein similarities
	elsif ($method eq "BLASTX")                       {push (@{$GFF{$file}{BLASTX}},$_);}
   	# C.briggsae similarities
	elsif (($method eq "WABA_coding") 
	       || ($method eq "WABA_strong")
               || ($method eq "WABA_weak"))               {push (@{$GFF{$file}{WABA_BRIGGSAE}},$_);}
   	# Assembly tags
	elsif ($method eq "assembly_tag")                 {push (@{$GFF{$file}{assembly_tags}},$_);}
	# TS site
	elsif ((/misc_feature/) && 
               (/trans-splice site/))                     {push (@{$GFF{$file}{ts_site}},$_);}
   	# Oligo mapping
	elsif ($feature eq "OLIGO")                       {push (@{$GFF{$file}{oligos}},$_);}
   	# RNAi
	elsif ($method eq "RNAi")                         {push (@{$GFF{$file}{RNAi}},$_);}
   	# GENEPAIR
	elsif ($method eq "GenePair_STS")                 {push (@{$GFF{$file}{genepair}},$_);}
   	# Alleles
	elsif (/Allele/)                                  {push (@{$GFF{$file}{allele}},$_);}
   	# Clone ends
	elsif ((/Clone_left_end/)  
               || (/Clone_right_end/))                    {push (@{$GFF{$file}{clone_ends}},$_);}
   	# PCR Products
	elsif (/PCR_product/)                             {push (@{$GFF{$file}{PCR_products}},$_);}
   	# cDNA for RNAi
	elsif (/cDNA_for_RNAi/)                           {push (@{$GFF{$file}{cDNA_for_RNAi}},$_);}
   	# BLAT_EST
	elsif (/BLAT_EST_BEST/)                           {push (@{$GFF{$file}{BLAT_EST_BEST}},$_);}
	elsif (/BLAT_EST_OTHER/)                          {push (@{$GFF{$file}{BLAT_EST_OTHER}},$_);}
   	# BLAT_mRNA
	elsif (/BLAT_mRNA_BEST/)                          {push (@{$GFF{$file}{BLAT_mRNA_BEST}},$_);}
	elsif (/BLAT_mRNA_OTHER/)                         {push (@{$GFF{$file}{BLAT_mRNA_OTHER}},$_);}
   	# BLAT_EMBL
	elsif (/BLAT_EMBL_BEST/)                          {push (@{$GFF{$file}{BLAT_EMBL_BEST}},$_);}
	elsif (/BLAT_EMBL_OTHER/)                         {push (@{$GFF{$file}{BLAT_EMBL_OTHER}},$_);}
   	# BLATX_NEMATODE
	elsif (/BLATX_NEMATODE/)                          {push (@{$GFF{$file}{BLATX_NEMATODE}},$_);}
   	# Expr_profile
	elsif (/Expr_profile/)                            {push (@{$GFF{$file}{Expr_profile}},$_);}
   	# UTR         
	elsif (/UTR/)                                     {push (@{$GFF{$file}{UTR}},$_);}
	# REST OF LINES
	else                                              {push (@{$GFF{$file}{rest}},$_); $running_total--;}
	
	# increment no of lines sorted to bin
	$running_total++; 
	
    }

    ########################################
    # count file lengths for all GFF files #
    ########################################

    # dropped for the moment

    ########################################
    # write some output                    #
    ########################################

    foreach my $tag (@gff_classes) {
	print "# $file $tag\n";

	open (OUT, ">$datadir/GFF_SPLITS/$file.$tag.gff") or die "Can't open file\n";

	# gff header lines
	foreach my $line (@header) {
	    next if ($line eq "");
	    print OUT "$line\n";
	}
	
	# gff split data lines
	foreach my $line (@{$GFF{$file}{$tag}}) {
	    next if ($line eq "");
	    print OUT "$line\n";
	}
	close OUT;
    }
    
    
    #########################################
    # Alter clone file to include accession #
    #########################################
   
    # GFF clone_path with EMBL accessions and sequence versions
    system ("GFF_with_accessions $datadir/GFF_SPLITS/$file.clone_path.gff > $datadir/GFF_SPLITS/$file.clone_acc.gff");

    # GFF genes with wormpep CE accessions
    system ("GFF_with_wormpep_accessions $datadir/GFF_SPLITS/$file.genes.gff > $datadir/GFF_SPLITS/$file.genes_acc.gff");
    system ("mv -f $datadir/GFF_SPLITS/$file.genes_acc.gff $datadir/GFF_SPLITS/$file.genes.gff");
    
    # GFF UTRs with CDS names
    system ("GFF_with_UTR_name $datadir/GFF_SPLITS/$file.UTR.gff > $datadir/GFF_SPLITS/$file.UTR_CDS.gff");
    system ("mv -f $datadir/GFF_SPLITS/$file.UTR_CDS.gff $datadir/GFF_SPLITS/$file.UTR.gff");
    
}
close LOG;


###############################
# Mail log to curator         #
###############################

open (OUTLOG,  "|/usr/bin/mailx -s \"WormBase Report: GFFsplitter\" $maintainers ");
open (READLOG, "<$logfile");
while (<READLOG>) {
    print OUTLOG "$_";
}
close READLOG;
close OUTLOG;

###############################
# hasta luego                 #
###############################

exit 0;

###############################
# subroutines                 #
###############################

sub file_size {
    my $file = shift;
    my $file_length;
    open (FILE_SIZE, "/bin/cat $file | wc -l |");
    while (<FILE_SIZE>) {
	chomp;
	s/\s//g;
	$file_length = $_;
    }
    close FILE_SIZE;
    print LOG "Counting No. of lines in file '$file' : $file_length\n" if ($debug);
    return $file_length;
}

__DATA__
clone_path
genes
pseudogenes
rna
CDS_exon
exon
exon_tRNA
exon_pseudogene
intron
intron_tRNA
intron_pseudogene
intron_confirmed_CDS
intron_confirmed_UTR
repeats
tc_insertions
BLASTX
WABA_BRIGGSAE
assembly_tags
ts_site
oligos
RNAi
genepair
alleles
clone_ends
PCR_products
cDNA_for_RNAi
BLAT_EST_BEST
BLAT_EST_OTHER
BLAT_mRNA_BEST
BLAT_mRNA_OTHER
BLAT_EMBL_BEST
BLAT_EMBL_OTHER
BLATX_NEMATODE
Expr_profile
UTR
rest
__END__






