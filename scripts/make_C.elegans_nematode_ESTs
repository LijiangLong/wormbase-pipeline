#!/usr/local/bin/perl5.8.0
#
# make_C.elegans_nematode_ESTs
#
# dl1
# 
# Last edited by: $Author: dl1 $
# Last edited on: $Date: 2003-06-13 13:47:58 $

$|=1;
use lib "/wormsrv2/scripts/";
use Wormbase;
use Getopt::Long;
use strict;
use Data::Dumper;

##############################
# command-line options       #
##############################

my $help;               # Help/Usage page
my $ace;                # Dump acefile

GetOptions (
	    "ace"            => \$ace,
            "help"           => \$help
	    );

# Help pod if needed
&usage(0) if ($help);

##############################
# Script variables (run)     #
##############################

my $acc;      # EMBL accession
my $id;       # EMBL ID   
my $sv;       # EMBL sequence version
my $def;      # EMBL description
my $OST;      # tag for OST/EST split
my %EST_name; # EST accession => name
my %EST_dir;  # EST accession => orientation [5|3]

# read hash for EST names 
open (FH, "</wormsrv2/autoace/BLAT/EST.dat") or die "EST.dat : $!\n";
    undef $/;
    my $data = <FH>;
    eval $data;
    die if $@;
    $/ = "\n";
    close FH;


open (OUT_EST, ">/nfs/disk100/wormpub/analysis/ESTs/C.elegans_nematode_ESTs");
open (OUT_OST, ">/nfs/disk100/wormpub/analysis/ESTs/C.elegans_nematode_OSTs");

if ($ace) {
    open (OUT_ACE, ">/nfs/disk100/wormpub/analysis/ESTs/C.elegans_nematode_ESTs.ace");
}
open (SEQUENCES, "/usr/local/pubseq/bin/getzc -sf fasta -f \"id acc des seq sv\" \'([embl-org:caenorhabditis elegans] \& [embl-div:est])\' |") ;

while (<SEQUENCES>) {
    if (/^AC\s+/ || /^DE\s+/ || /^>/ || /^ID\s+/ || /^SV\s+/) {
    } 
    else {
	print OUT_EST  if ($OST == 0);
	print OUT_ACE  if (($OST == 0) && ($ace));
	print OUT_OST  if ($OST == 1);

    }
    
    if (/^AC\s+(\S+);/) {
	$acc = $1;
    }
    if (/^ID\s+(\S+)/)  {
	$id = $1;
    }
    if (/^SV\s+\S+\.(\d+)/) {
	$sv  = $1;
    }
    if (/^DE\s+(.+)/)   {
	$def = $def." ".$1;
	
	if ($def =~ /^ OST/) {
	    $OST = 1;
	}
	else {
	    $OST = 0;
	}
    }
    if (/^>/) {
	if ($OST == 0) {
	    print OUT_EST ">$acc $id $def\n";
	    
	    if ($ace) {
	       if (exists $EST_name{$acc}) {
	       		print OUT_ACE "\nSequence : \"$EST_name{$acc}\"\nDatabase EMBL $id $acc $sv\n";
		}
		else {	
		print OUT_ACE "\nSequence : \"$acc\"\nDatabase EMBL $id $acc $sv\n";
		}
		print OUT_ACE   "Species \"Caenorhabditis elegans\"\n";
		print OUT_ACE   "Title \"$def\"\nMethod EST_elegans\n";
		
	       if (exists $EST_name{$acc}) {
		   print OUT_ACE "\nDNA \"$EST_name{$acc}\"\n";
	       }
	       else {	
		   print OUT_ACE   "\nDNA \"$acc\"\n";
	       }
	    }

	    $def = "";
	    $id  = "";
	    $sv  = "";
	    $acc = "";
	} 
	else {
	    print OUT_OST ">$acc $id $def\n";
	    $def = "";
	    $id  = "";
	    $sv  = "";
	    $acc = "";
	}
    }
}
close SEQUENCES;
close OUT_EST;
close OUT_OST;
close OUT_ACE if ($ace);


#######################################################################
# Help and error trap outputs                                         #
#######################################################################

sub usage {
    my $error = shift;
    if ($error == 0) {
        # Normal help menu
        exec ('perldoc',$0);
    }
}


__END__

=pod

=head2   NAME - make_C.elegans_nematode_ESTs

=head1 USAGE

=over 4

=item make_C.elegans_nematode_ESTs

=back

make_C.elegans_nematode_ESTs runs an SRS query on the EMBL database
to return all C.elegans sequences from the EST division. This set
is then split using a simple perl regex into the OST set (Marc Vidal's
Orfeome project 1.1) and everything else. These files are used for the
BLAT analysis as part of each WormBase build.

=back

=cut
