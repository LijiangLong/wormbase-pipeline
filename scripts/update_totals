#!/usr/local/bin/perl5.6.1 -w
#
# update_totals
#
# dl
#
# updates the sequencing totals on the external WWW site
#
# Usage : update_totals
#
# Last updated by: $Author: dl1 $
# Last updated on: $Date: 2002-11-14 15:05:09 $
#
# see pod documentation (i.e. 'perldoc update_totals') for more information.
#
#####################################################################################################



#################################################################################
# variables                                                                     #
#################################################################################

$|=1;
use strict;
use Getopt::Long;

 ##############################
 # paths etc                  #
 ##############################

my $cmid        = "/nfs/disk100/wormpub/analysis/cosmids/cmid";
my $unfincmid   = "/nfs/disk100/wormpub/analysis/Sequence_Databases/unfincmid";
my $composition = "/nfs/disk100/wormpub/bin.ALPHA/composition";
my $count_fin   = "/nfs/disk2/sign/orginfo/celegans.fin";
my $count_unfin = "/nfs/disk2/sign/orginfo/celegans.unfin";
my $fin;
my $unfin;

 ##############################
 # run time variables         #
 ##############################


my $maintainer = "dl1\@sanger.ac.uk";
my $rundate = `date +%y%m%d`; chomp $rundate;
my $runtime = `date +%H:%M:%S`; chomp $runtime;

 ##############################
 # command-line options       #
 ##############################

my $help;       # Help perdoc
my $debug;      # Debug mode, verbose output to dl1 only

GetOptions (
            "debug"     => \$debug,
            "help"      => \$help
            );

# help page
&usage("Help") if ($help);

 ##############################
 # calculate finished total   #
 ##############################

open (FIN, "$composition $cmid |");
while (<FIN>) {
    ($fin = $1) if (/(\d+)\s+total$/);
}
close FIN;

print "Finished sequences total $fin bp\n" if ($debug);

 ##############################
 # calculate unfinished total #
 ##############################

open (UNFIN, "$composition $unfincmid |");
while (<UNFIN>) {
    ($unfin = $1) if (/(\d+)\s+total$/);
}
close UNFIN;

print "Unfinished sequences total $unfin bp\n" if ($debug);

 ##############################
 # update celegans.fin        #
 ##############################

if (-e $count_fin) {
    unlink $count_fin;
    open (NEW_FIN, ">$count_fin");
    print NEW_FIN $fin;
    close NEW_FIN;
}

 ##############################
 # update celegans.unfin      #
 ##############################

if (-e $count_unfin) {
    unlink $count_unfin;
    open (NEW_UNFIN, ">$count_unfin");
    print NEW_UNFIN $unfin;
    close NEW_UNFIN;
}

 ##############################
 # mail $maintainer report    #
 ##############################

open (LOG,  "|/usr/bin/mailx -s \"WormBase Report: update_totals\" $maintainer ");
print LOG "# update_totals\n";
print LOG "# run details     : $rundate $runtime\n";
print LOG "\n";
print LOG "Finished sequence   : $fin\n";
print LOG "Unfinished sequence : $unfin\n\n";
close LOG;

 ##############################
 # a extremidade              #
 ##############################

exit(0);


###############################
# Prints help and disappears  #
###############################

sub usage {
    my $error = shift;

    if ($error eq "Help") {
        # Normal help menu
        system ('perldoc',$0);
        exit (0);
    }
}

__END__

=pod

=head2 NAME - update_totals

=head2 USAGE

=over 4

=item update_totals [-options]

=back

update_totals will calculate the lengths of the finished and unfinished fasta
databases and overwrite the text files used to produce the Sanger sequence
statistics pages (http://www.sanger.ac.uk/Info/Statistics/)

update_totals mandatory arguments:

=over 4

=item none

=back

update_totals OPTIONAL arguments:

=over 4

=item -help, Help

=back

=head2 CRON

=over 4

=item Yes, (Daily)

=back

=head2 INPUT

The following files are required for update_totals to work:

=over 4

=item /nfs/disk100/wormpub/analysis/Sequence_Databases/cmid

=item /nfs/disk100/wormpub/analysis/Sequence_Databases/unfincmid

=back

=head2 OUTPUT

The following files are produced by update_totals:

=over 4

=item /nfs/disk2/sign/orginfo/celegans.fin

=item /nfs/disk2/sign/orginfo/celegans.unfin

=back

=head2 REPORT LOGGING

The script writes a logfile which is mailed to the maintainer

=head2 AUTHOR

Dan Lawson (B<dl1@sanger.ac.uk>)

=cut




